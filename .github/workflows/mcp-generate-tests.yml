name: Generate AI Unit Tests

on:
  push:
    paths:
      - "src/**"      # triggers when anything inside src/ changes
    branches:
      - main
permissions:
  contents: write
jobs:
  generate-tests:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Checkout the repo
    - name: Checkout code
      uses: actions/checkout@v3

    # 2️⃣ Setup Python (for MCP server client)
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    # 3️⃣ Install dependencies
    - name: Install dependencies
      run: |
        pip install openai fastapi uvicorn

    # 4️⃣ Call MCP server to generate tests
    - name: Generate AI tests via MCP
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        curl -X POST https://luther-unmagnetical-lumpingly.ngrok-free.dev/generate-tests \
        -H "Content-Type: application/json" \
        -d '{"repo":"GithubCopilot","pr":1}'

    # 5️⃣ Commit and push generated tests back to GitHub
    - name: Commit and push AI tests
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"
        git checkout -b ai-generated-tests || git checkout ai-generated-tests
        git add tests/
        git commit -m "Add AI-generated tests" || echo "No changes to commit"
        git push -u origin ai-generated-tests
